<script src="socket.io.js"></script>
<script src="EventEmitter.js"></script>
<script src="websocket-session.js"></script>
<script>
    /*    const socket = io('ws://localhost:82');

        socket.on('connect', () => {
            socket.send('Hello from io client');
        });

        socket.on('message', data => {
            console.log(data);
        });*/



    // Create a new line chart object where as first parameter we pass in a selector
    // that is resolving to our chart container element. The Second parameter
    // is the actual data object.


</script>


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocketioORwebsocket</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
</head>
<body>
    <header>
        <section>
            <h1>Актуальная информация о самых известных валютах</h1>
            <div class="buttons">
                <a href="">WebSocket</a>
                <a class="btn_disabled" href="">SocketIO</a>
            </div>
        </section>
    </header>
    <nav class="currencys-wrapper scrollable-container">
        <ul id="currency-container" class="scrollable-wrapper-column">
            <li>
                <a href="javascript:TouchCurrency('dollar');">Currency</a>
            </li>
        </ul>
    </nav>
    <section class="info-blocks scrollable-container">
        <div id="info-blocks-container" class="scrollable-wrapper-column">
            <div class="info-block">
                <div class="name" id="name-first-currency">Доллар</div>
                <div class="exchange-rate" id="exchange-rate-first-currency">75,86</div>
                <div class="label-date">Дата:</div>
                <div class="date" id="date-first-currency">29.11.2020</div>
                <div class="label-number-code">Цифровой код:</div>
                <div class="number-code" id="number-code-first-currency">84034234244sdsadad</div>
                <div class="label-letter-code">Буквенный код:</div>
                <div class="letter-code" id="letter-code-first-currency">USD</div>
            </div>
        </div>
    </section>
    <section class="schedule-wrapper">
        <div class="schedule">
            <div class="ct-chart ct-major-seventh"></div>

        </div>
    </section>
    <footer>
        <section>
            <h3>SocketioORwebsocket</h3>
        </section>
    </footer>
    <script>

        /*
        структура для графика
        */
        var data_for_schedule = {
            // A labels array that can contain any sort of values
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
            // Our series array that contains series objects or in this case series data arrays
            series: [
                [5, 2, 4, 2, 10]
            ]
        };

        /*
        метод для первой отрисовки графика
        */
        var myChart; //публичная переменная для хранения ссылки на график
        function PaintStartSchedule() {
            myChart = new Chartist.Line('.ct-chart', data_for_schedule);
        }
        PaintStartSchedule();





        //контейнер для кнопок меню
        var currencyContainer = document.getElementById("currency-container");
        //контейнер для дополнительных областей
        var infoBlocksContainer = document.getElementById("info-blocks-container");
        //список последних 50-ти дат получения данных
        let dateLabels = [];
        //список имён валют, которые открыты для просмотра в данный момент
        let nowSeeCurrenciesNames = [];

        /*
        обновление списка последних 50-ти дат
        */
        function UpdateDateLabels(currency){
            if(dateLabels.length < 50){
                dateLabels.push(currency.date);
            } else {
                dateLabels.shift();
                dateLabels.push(currency.date);
            }
        }

        /*
        функция добавления новой валюты в список валют
        */
        function AddNewCurrency(currencyName) {
            currencyContainer.innerHTML += "<li><a id=\""
                + currencyName + "-button"
                + "\" href=\"javascript:TouchCurrency('"
                + currencyName + "');\">" + currencyName +"</a></li>";
        }

        /*
        обновление информации по валюте в блок доп информации
        */
        function UpdateDataInCurrencyBlock(currencyName) {
            var blockId = currencyName + "-currency-container";
            var infoBlock = document.getElementById(blockId);

            var currencyPrice = "";
            var currencyDate = "";
            var currencyCode = "";

            for(var i = 0; i < currencies_data.length; i++){
                if(currencies_data[i].name === currencyName){
                    currencyPrice = currencies_data[i].price;
                    currencyDate = currencies_data[i].date;
                    currencyCode = currencies_data[i].code;
                }
            }

            infoBlock.innerHTML = "<div class=\"name\">" + currencyName + "</div>\n" +
                "<div class=\"exchange-rate\">" + currencyPrice + "</div>\n" +
                "<div class=\"label-date\">Дата:</div>\n" +
                "<div class=\"date\">" + currencyDate + "</div>\n" +
                "<div class=\"label-number-code\">Цифровой код:</div>\n" +
                "<div class=\"number-code\">" + currencyCode + "</div>\n" +
                "<div class=\"label-letter-code\">Буквенный код:</div>\n" +
                "<div class=\"letter-code\"></div>";
        }

        /*
        добавление нового блока с дополнительной информацией
        */
        function AddNewCurrencyBlock(currencyName) {
            var blockId = currencyName + "-currency-container";
            infoBlocksContainer.innerHTML += "<div id=\""
                + blockId
                + "\" style=\"display: none\" class=\"info-block\">\n</div>";

            UpdateDataInCurrencyBlock(currencyName);
        }

        /*
        Предстартовое насыщение страницы списком валют
        и областями для предпросмотра.
        Все области изначально хранят display:none.
        */
        function ParseDataBeforeStart() {
            currencyContainer.innerHTML = "";
            infoBlocksContainer.innerHTML = "";
            currencies_data.forEach(function (item) {
                AddNewCurrency(item.name);
                AddNewCurrencyBlock(item.name);
            });
        }





        /*
        получение новых данных и их обновление
        */
        var currencies_data = [];
        const websocket = new WebsocketSession('ws://localhost:81');
        document.flag = false;
        websocket.on('message', data => {
            console.log(data);
            currencies_data = data;

            if(!document.flag) {
                ParseDataBeforeStart()
                document.flag = true;
            }
            for(let cur of data){
                UpdateDataInCurrencyBlock(cur.name);
                UpdateDateLabels(cur);
            }
        });







        /*
        открытие блока дополнительных данных
        */
        function OpenInfoBlock(currencyName){
            var infoBlock = document.getElementById(currencyName + "-currency-container");

            if (infoBlock.style.display === "none") {
                infoBlock.style.display = "grid";
                UpdateDataInCurrencyBlock(currencyName);
                return "on";
            } else {
                infoBlock.style.display = "none";
                return "off";
            }
        }

        /*
        функция для кнопки меню
        */
        function TouchCurrency(currencyName) {
            var currencyButton = document.getElementById(currencyName + "-button");
            if(OpenInfoBlock(currencyName) === "on"){
                currencyButton.classList.add("selected-currency");
            } else {
                currencyButton.classList.remove("selected-currency");
            }
        }
    </script>
</body>
</html>
